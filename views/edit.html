{% extends "layout.html" %} {% block title %}登录{% endblock %} {% block head %}
<style>
    * {
        background-color: transparent;
    }

    html,
    body {
        padding: 0;
        margin: 0;
        font-family: "Helvetica Neue", Helvetica, Arial, "Microsoft Yahei", "Hiragino Sans GB", "Heiti SC", "WenQuanYi Micro Hei", sans-serif;
        overflow-x: hidden;
    }

    .editList {
        list-style: none;
        padding-left: 0;
        margin: 0;
    }

    header {
        height: 50px;
        width: 100%;
        top: 0;
        position: fixed;
        background-color: #03A9F4;
        color: #fff;
        line-height: 50px;
        display: flex;
        clear: both;
    }

    .btnMore,
    .btnReturn {
        position: relative;
        /* justify-content: center; */
        left: 10px;
        height: 30px;
        width: 50px;
        display: inline-block;
        padding: 10px 0;
    }

    header > a > span > img {
        width: 30px;
        margin: 8px 0 8px;
    }

    header > a {
        width: 50px;
        cursor: pointer;
    }
    
    #userPost {
        margin: 50px auto 0;
    }

    .subform,
    .subform > label,
    .textarea {
        margin: 0;
    }

    #editContent {
        padding: 0;
        width: 100%;
        resize: none;
        height: 100%;
        display: inline-block;
        text-align: left;
        font-size: 16px;
        outline: none;
        border: none;
    }

    .subform > label > textarea {
        width: 100%;
        height: 33px;
        border: none;
        border-bottom: 1px solid #ddd;
        font-size: 16px;
        color: #32b9f6;
        outline: none;
        overflow-y: visible;
        resize: none;
        margin-top: 4px;
        padding: 0;
    }

    .editList > li {
        padding: 8px 12px 0;
    }

    .editList > li:first-child {
        padding-top: 8px;
        padding-bottom: 0;
    }

    #btnMore {
        position: absolute;
        right: 0;
    }

    .btnReturn > img {
        transition: all 1.2s;
        /*opacity:1;*/
    }

    .toggleToSave {
        opacity: 0;
        -webkit-transform: rotate(120deg);
        -moz-transform: rotate(120deg);
        -ms-transform: rotate(120deg);
        -o-transform: rotate(120deg);
        transform: rotate(120deg);
    }

    .togglewarp {
        width: 38px;
        height: 18px;
        display: block;
        margin: 10px auto 10px;
        text-align: center;
        /* align-items: center; */
        padding: 6px;
    }

    .btnToggle {
        width: 14px;
        height: 3px;
        display: inline-block;
        margin: 1px;
        background-color: #fff;
    }

    .Toggle1 {
        transform: rotate(-45deg);
        z-index: 4;
        transition: all 0.8s;
    }

    .ToggleAfter1 {
        transform: rotate(0deg);
        opacity: 0;
    }

    .Toggle2 {
        width: 20px;
        position: relative;
        padding-left: -14px;
        left: 4px;
        transition: all 0.8s;
    }

    .ToggleAfter2 {
        transform: rotate(-45deg);
    }

    .Toggle3 {
        transform: rotate(45deg);
        transition: all 0.8s;
    }

    .ToggleAfter3 {
        transform: rotate(225deg);
        width: 11px;
        left: -6px;
        top: -1px;
        position: relative;
    }

    #btnSave {
        z-index: -1;
        position: absolute;
        left: 0;
        top: 0;
        height: 50px;
        background: transparent;
    }

    .btnMore > span {
        width: 6px;
        background-color: #fff;
        height: 6px;
        border-radius: 3px;
        display: block;
        margin: 2px 0 0 10px;
    }
    .btnMenu {
        width: 170px;
        display: inline-block;
        position: absolute;
        right: 3px;
        top: 3px;
        background-color: #fff;
        border-radius: 3px;
        box-shadow: -3px 1px 27px #cdcdcd;
        transition: all 0.3s;
    }

    .btnMenu > a {
        display: inherit;
        padding: 0 12px;
        color: #282828;
        text-decoration: none;
    }

    .btnMenuHide {
        right: -180px;
        top: -155px
    }
</style>
{% endblock %} {% block content %}
<header>
    <div href="#" id="btnBack" action="back">
        <span class="togglewarp ">
            <span class="btnToggle Toggle1"></span>
        <span class="btnToggle Toggle2"></span>
        <span class="btnToggle Toggle3"></span>
        </span>
    </div>
    <div id="btnMore">
        <span class="btnMore">
            <span></span>
            <span></span>
            <span></span>
        </span>
        <span class="btnMenu btnMenuHide" id="optFun">
            <!--TODO-->
            <!--后台返回一个nav地址变量,我能判断是否是新建任务，然后觉得是否要隐藏这些功能-->
            {% if nav!="add"%}
                <a href="#" title="remember">记住了</a>
                <a href="#" title="enhance">没记住</a>
                <a href="#" title="done">完成</a>
                <a href="#" title="detail">任务详情</a>
            {% endif %}
            <a href="#" title="edit">编辑</a>
            <a href="#" title="delete">删除</a>
        </span>
        <span></span>
        <span></span>
        </span>
        <span class="btnMenu btnMenuHide" id="optFun">
            <!--TODO-->
            <!--后台返回一个nav地址变量,我能判断是否是新建任务，然后觉得是否要隐藏这些功能-->
            {% if nav!="add"%}
                <a href="#" title="remember">记住了</a>
                <a href="#" title="enhance">没记住</a>
                <a href="#" title="done">完成</a>
                <a href="#" title="detail">任务详情</a>
            {% endif %}
            <a href="#" title="edit">编辑</a>
            <a href="#" title="delete">删除</a>
        </span>
    </div>
</header>
<form action="/reminder/add" method="post" id="userPost">
    <section class="warp" id="formContent">
        <ul class="editList">
            <li>
                <p class="subform">
                    <label for="title">
                    <textarea name="title" id="title" required placeholder="标题"
                              disabled>{{ json.reminder.data.title }}</textarea>
                    </label></p>
            </li>
            <li>
                <p class="textarea">
                    <textarea name="content" id="editContent" required placeholder="想记什么？" disabled>{{ json.reminder.data.content }}</textarea>
                </p>
            </li>
        </ul>
        <input type="hidden" name="shortid" id="shortid" value="{{ json.reminder.shortid }}">
    </section>
</form>
<script type="text/javascript">
    (function (doc) {
        var btnSave = doc.getElementById('btnSave'),
                togglewarp = doc.getElementsByClassName('togglewarp')[0].getElementsByTagName('span'),
                title = doc.getElementById('title'),
                editContent = doc.getElementById('editContent'),
                shortid = doc.getElementById('shortid'),
                userPost = doc.getElementById('userPost'),
                btnMore = doc.getElementById("btnMore"),
                btnBack = doc.getElementById("btnBack"),
                optFun = doc.getElementById("optFun"),
                btnMenu = doc.getElementsByClassName('btnMenu')[0];

        function onEdit() {
            //返回键修改
            for (i = 1; i <= togglewarp.length; i++) {
                togglewarp[i - 1].className += ' ToggleAfter' + i;
            }
            //隐藏编辑按键
            title.disabled = false;
            editContent.disabled = false;
            btnMenu.className = 'btnMenu btnMenuHide';
            btnBack.setAttribute('action', 'save');
            setTimeout(function () {
                if (title.value.length > 0) {
                    editContent.focus();
                } else {
                    title.focus();
                }
            }, 500);
        }

        //默认标题
        function defaultTitle() {
            var nD = new Date();
            var m = nD.getMonth() + 1;
            if (m < 10)m = "0" + m;
            var d = nD.getDate();
            if (d < 10)d = "0" + d;
            return ['Task', m, d].join('-');
        }

        function complieDate() {
            //初始化数据
            var data = {
                title: title.value,
                content: editContent.value,
            };
            return "shortid=" + shortid.value + "&data=" + encodeURIComponent(JSON.stringify(data));
        }

        //保存更改
        function onSave() {
            //检查数据
            editContent.value = editContent.value.trim();
            title.value = title.value.trim();
            if (title.value.length == 0)title.value = defaultTitle();
            if (editContent.value.length == 0) {
                confirm('想记的事情为空，是否放弃编辑？') && onBack();
                return false;
            }
            //显示编辑按键
            for (i = 1; i <= togglewarp.length; i++) {
                togglewarp[i - 1].className = 'btnToggle Toggle' + i;
            }
            title.disabled = true;
            editContent.disabled = true;
            btnBack.setAttribute('action', 'back');
            //发送ajax请求
            xhr(complieDate(), 'post', '/reminder/add', function (err, result) {
                //callback fun
            });
        }

        //返回主页
        function onBack() {
            location.href = '/reminder/list/action';
        }

        function onDisplyDetail() {
            var seriseUrl = '/reminder/' + shortid.value + '/detail';
            xhr(null, 'get', seriseUrl, function (err, result) {
                if (err) {
                    return true;
                } else {
                    if (result.state && result.state == 'ok') {
                        //TODO 待测试
                        //获取成功后，绘制详情页面
                        var ulList = document.createElement('ul');
                        ulList.className = 'taskDetail';
                        for (var key in result.reminder) {
                            var liList = doc.createElement('li');
                            liList.innerHTML = key + ":" + result.reminder[key];
                            ulList.appendChild(liList);
                        }
                        doc.body.appendChild(ulList);
                        var ulListLinsten = doc.getElementsByClassName('taskDetail')[0];
                        ulListLinsten.addEventListener('click', function () {
                            ulListLinsten.removeEventListener('click', null);
                            ulListLinsten.remove();
                        })
                    } else {
                        alert('Oops,some error was happened...');
                    }
                }
            })
        }


        btnBack.addEventListener('click', function () {
            if (btnBack.getAttribute('action') == 'save') {
                onSave();
            } else {
                onBack();
            }
        });


        userPost.onsubmit = function () {
            return postEdit() ? false : true
        };

        //菜单栏详情展开
        btnMore.addEventListener('click', function () {
            btnMenu.className = 'btnMenu';
            userPost.addEventListener('click', function () {
                btnMenu.className = 'btnMenu btnMenuHide';
                userPost.removeEventListener('click', null);
            })
        }, true);

        //绑定菜单栏里的事件
        for (var t = 0; t < optFun.children.length; t++) {
            optFun.children[t].addEventListener('click', function () {
                var optTitle = this.title || false;
                if (optTitle && (optTitle == 'edit')) {
                    //绑定编辑事件
                    onEdit();

                } else if (optTitle && (optTitle == 'detail')) {
                    //绑定展示详情
                    onDisplyDetail();
                } else if (optTitle) {
                    //绑定菜单点击事件
                    onOpt(optTitle);
                }
            })
        }


        //菜单栏事件触发器
        function onOpt(opt) {
            var confTitle;
            switch (opt) {
                case 'delete':
                    confTitle = '确认删除该事件提醒？';
                    break;
                case 'done':
                    confTitle = '完成记忆了？';
                    break;
                case 'remember':
                    confTitle = '已经记住啦？';
                    break;
                case 'enhance':
                    confTitle = '还没记住?';
                    break;
                default:
                    confTitle = false;
                    break;
            }

            //提示信息和响应操作
            if (confTitle && confirm(confTitle)) {
                var optUrl = '/reminder/' + shortid.value + '/' + opt;
                xhr(null, 'get', optUrl, function (err, result) {
                    //todo
                    //页面跳转有问题，后台跳转不了
                    //可以用回调事件完成跳转
                })
            }
            btnMenu.className = 'btnMenu btnMenuHide';
        }

        //xhr发送请求
        function xhr(data, method, url, callback) {
            var xhr = new XMLHttpRequest();
            if (xhr) {
                xhr.open(method, url, true);
                xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                //XML请求，后台可以通过req.xhr==true来判断请求类型是否为xhr
                xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
                xhr.onreadystatechange = function () {
                    if (xhr.readyState == 4 && xhr.status == 200) {
                        var responseData = xhr.responseText || false;
                        callback(false, JSON.parse(responseData));
                    } else {
                        callback(true);
                    }
                };
                xhr.send(data);
                return true;
            } else {
                alert('Sorry,your browser doesn\'t support XMLHttpRequeset');
                return false;
            }
        }

        //调整页面以适应屏幕尺寸
        //设置默认标题
        var titleHeight = title.style.height;
        titleHeight = titleHeight == '' ? 37 : parseInt(titleHeight);
        title.placeholder = "标题(" + defaultTitle() + ")";
        editContent.style.height = parseInt(doc.body.clientHeight) - titleHeight - 88;
        {% if json.reminder %}
        {% else %}
        onEdit()
        {%  endif %}
    })(document);
</script> {% endblock %}